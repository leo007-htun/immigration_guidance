name: Deploy to IONOS VPS

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          debug: true
          command_timeout: 40m
          script_stop: true
          script: |
            set -euo pipefail
            echo "== connected =="; whoami || true; uname -a || true; date

            # Detect docker compose command
            if docker compose version >/dev/null 2>&1; then
              COMPOSE="docker compose"
            elif command -v docker-compose >/dev/null 2>&1; then
              COMPOSE="docker-compose"
            else
              echo "❌ Neither 'docker compose' nor 'docker-compose' installed"; exit 1
            fi

            REPO_PATH="${{ secrets.APP_PATH || '/root/immigration_guidance' }}"
            mkdir -p "$REPO_PATH"

            # Clone repo if missing
            if [ ! -d "$REPO_PATH/.git" ]; then
              git clone git@github.com:leo007-htun/immigration_guidance.git "$REPO_PATH"
            fi

            cd "$REPO_PATH"
            git fetch --all --prune
            git reset --hard origin/main

            # Detect compose file
            COMPOSE_FILE=""
            for f in docker-compose.yml docker-compose.yaml compose.yml compose.yaml; do
              if [ -f "$f" ]; then COMPOSE_FILE="$f"; break; fi
            done
            if [ -z "$COMPOSE_FILE" ]; then
              echo "❌ No compose file found"; ls -la; exit 1
            fi
            $COMPOSE -f "$COMPOSE_FILE" config >/dev/null

            # Generate .env file
            cat <<EOF > .env
            ADMIN_KEY=${{ secrets.ADMIN_KEY }}
            DATABASE_HOST=${{ secrets.DATABASE_HOST }}
            DATABASE_NAME=${{ secrets.DATABASE_NAME }}
            DATABASE_PASSWORD=${{ secrets.DATABASE_PASSWORD }}
            DATABASE_PORT=${{ secrets.DATABASE_PORT }}
            DATABASE_USER=${{ secrets.DATABASE_USER }}
            OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
            ORG_ID=${{ secrets.ORG_ID }}
            POSTGRES_DB=${{ secrets.POSTGRES_DB }}
            POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
            POSTGRES_USER=${{ secrets.POSTGRES_USER }}
            EOF

            # Optional: Clean up dangling containers/images before build
            echo "Pruning old containers, images, and build cache..."
            $COMPOSE -f "$COMPOSE_FILE" down --remove-orphans || true
            docker system prune -af --volumes || true

            # Build Docker images
            echo "Building Docker images..."
            $COMPOSE -f "$COMPOSE_FILE" build --no-cache

            # Start services
            echo "Starting services..."
            $COMPOSE -f "$COMPOSE_FILE" up -d --remove-orphans

            # Wait for services
            echo "Waiting 30 seconds for services to initialize..."
            sleep 30

            # Check service status
            $COMPOSE -f "$COMPOSE_FILE" ps || true

            # Build LEANN index
            echo "Building LEANN index from documents..."
            $COMPOSE -f "$COMPOSE_FILE" exec -T backend python3 /app/src/utils/leann_converter.py || true

            # Final cleanup: remove unused images and cache
            echo "Final cleanup of Docker images and cache..."
            docker image prune -af || true
            docker builder prune -af || true

            echo "Deployment complete!"
