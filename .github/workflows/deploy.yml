name: Deploy to IONOS VPS

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          debug: true
          script: |
            set -euo pipefail

            # Detect docker compose command
            if docker compose version >/dev/null 2>&1; then
              COMPOSE="docker compose"
            elif command -v docker-compose >/dev/null 2>&1; then
              COMPOSE="docker-compose"
            else
              echo "âŒ Neither 'docker compose' nor 'docker-compose' installed"; exit 1
            fi

            APP_PATH="${{ secrets.APP_PATH || '/root/immigration_guidance' }}"
            REPO="git@github.com:leo007-htun/immigration_guidance.git"

            # Clone repo if missing
            if [ ! -d "$APP_PATH/.git" ]; then
              echo "Folder does not exist, creating and cloning repo..."
              mkdir -p "$APP_PATH"
              git clone "$REPO" "$APP_PATH"
            fi

            cd "$APP_PATH"

            # Reset and pull latest code
            echo "Pulling latest code..."
            git reset --hard
            git clean -fd
            git pull origin main

            # Generate .env file (without extra indentation)
            echo "Generating .env file..."
            cat > .env <<EOF
            ADMIN_KEY=${{ secrets.ADMIN_KEY }}
            DATABASE_HOST=${{ secrets.DATABASE_HOST }}
            DATABASE_NAME=${{ secrets.DATABASE_NAME }}
            DATABASE_PASSWORD=${{ secrets.DATABASE_PASSWORD }}
            DATABASE_PORT=${{ secrets.DATABASE_PORT }}
            DATABASE_USER=${{ secrets.DATABASE_USER }}
            OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
            ORG_ID=${{ secrets.ORG_ID }}
            POSTGRES_DB=${{ secrets.POSTGRES_DB }}
            POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
            POSTGRES_USER=${{ secrets.POSTGRES_USER }}
            EOF

            # Build Docker images
            echo "Building Docker images..."
            $COMPOSE build

            # Stop old containers
            echo "Stopping old containers..."
            $COMPOSE down --remove-orphans

            # Prune only dangling images (safer)
            echo "Pruning dangling Docker images..."
            docker image prune -f

            # Start services
            echo "Starting services..."
            $COMPOSE up -d --remove-orphans

            # Wait for services
            echo "Waiting 30 seconds for services to initialize..."
            sleep 30

            # Check service status
            echo "Checking service status..."
            $COMPOSE ps

            # Build LEANN index
            echo "Building LEANN index from documents..."
            $COMPOSE exec -T backend python3 /app/src/utils/leann_converter.py || true

            echo "Deployment complete!"
